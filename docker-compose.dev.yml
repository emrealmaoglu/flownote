# FlowNote Development Environment
# Usage: docker-compose -f docker-compose.dev.yml up

version: '3.8'

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  db:
    image: postgres:15-alpine
    container_name: flownote-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-flownote}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
      POSTGRES_DB: ${DB_NAME:-flownote_dev}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DB_USER:-flownote} -d ${DB_NAME:-flownote_dev}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - flownote-network

  # ============================================
  # Backend API (NestJS)
  # ============================================
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile.dev
    container_name: flownote-backend
    restart: unless-stopped
    environment:
      NODE_ENV: development
      PORT: 3000
      # Database
      DATABASE_URL: postgresql://${DB_USER:-flownote}:${DB_PASSWORD:-changeme}@db:5432/${DB_NAME:-flownote_dev}
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: ${DB_USER:-flownote}
      DB_PASSWORD: ${DB_PASSWORD:-changeme}
      DB_NAME: ${DB_NAME:-flownote_dev}
      # Auth
      JWT_SECRET: ${JWT_SECRET:-changeme_min_32_chars_for_security_reasons}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
      # Sync (if applicable)
      SYNC_ENABLED: ${SYNC_ENABLED:-true}
    volumes:
      # Bind mount source for hot-reload
      - ./backend/src:/app/backend/src:delegated
      - ./backend/test:/app/backend/test:delegated
      - ./shared:/app/shared:delegated
      # Anonymous volume for node_modules (prevents host overwrite)
      - /app/node_modules
      - /app/backend/node_modules
    ports:
      - "${BACKEND_PORT:-3000}:3000"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - flownote-network
    # Override for debugging
    # command: ["npm", "run", "start:debug"]

    # ============================================
    # Frontend (React + Vite)
    # ============================================
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile.dev
    container_name: flownote-frontend
    restart: unless-stopped
    environment:
      NODE_ENV: development
      VITE_API_URL: http://localhost:${BACKEND_PORT:-3000}
      VITE_WS_URL: ws://localhost:${BACKEND_PORT:-3000}
    volumes:
      # Bind mount source for HMR
      - ./frontend/src:/app/frontend/src:delegated
      - ./frontend/public:/app/frontend/public:delegated
      - ./shared:/app/shared:delegated
      # Anonymous volume for node_modules
      - /app/node_modules
      - /app/frontend/node_modules
    ports:
      - "${FRONTEND_PORT:-5173}:5173"
    depends_on:
      - backend
    networks:
      - flownote-network

  # ============================================
  # Adminer (Database GUI) - Optional
  # ============================================
  adminer:
    image: adminer:4-standalone
    container_name: flownote-adminer
    restart: unless-stopped
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    environment:
      ADMINER_DEFAULT_SERVER: db
      ADMINER_DESIGN: dracula
    depends_on:
      - db
    networks:
      - flownote-network
    profiles:
      - tools

# ============================================
# Volumes
# ============================================
volumes:
  postgres_data:
    driver: local

# ============================================
# Networks
# ============================================
networks:
  flownote-network:
    driver: bridge
